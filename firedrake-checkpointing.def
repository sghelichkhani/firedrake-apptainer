Bootstrap: localimage
From: containers/ompi-mkl.sif

%files
    files/__init__.py /mnt/files/
    files/solving_modified.py /mnt/files/
    files/eigen-3.3.3.tar.gz /mnt/files/

%environment
    export OMPI_DIR=/opt/ompi
    export PATH="$OMPI_DIR/bin:$PATH"
    export LD_LIBRARY_PATH="$OMPI_DIR/lib:$LD_LIBRARY_PATH"
    export PETSC_DIR=/opt/petsc
    export PETSC_ARCH=arch-linux-c-opt

%post
    # getting system variables
    source /opt/intel/oneapi/setvars.sh

    # we need petsc and a few other libraries 
    dnf install -y python39 procps-ng gcc gcc-gfortran git libnl3-devel numactl-devel boost-devel

    # petsc installation
    cd /opt && git clone https://gitlab.com/petsc/petsc.git 

    # moving to petsc directory 
    cd petsc

    # chenging branch: to kokis modification 
    git checkout ksagiyam/plex_io_freeze_distribution

    # build
    python3 configure --with-fortran-bindings=0 --with-mpiexec=mpiexec --with-cc=mpicc --with-cxx-dialect=C++11 --with-c2html=0 --with-fc=mpif90 --with-blaslapack-lib="-L${MKLROOT}/lib/intel64 -lmkl_rt -Wl,--no-as-needed -lpthread -lm -ldl" --with-zlib --with-shared-libraries=1 --with-cxx=mpicxx --with-debugging=0 --download-eigen=/mnt/files/eigen-3.3.3.tar.gz --download-hypre --download-suitesparse --download-scalapack --download-superlu_dist --download-ml --download-ptscotch --download-pnetcdf --download-metis --download-chaco --download-hwloc --download-hdf5 --download-netcdf --download-pastix --download-mumps

    # installation
    make PETSC_DIR=/opt/petsc PETSC_ARCH=arch-linux-c-opt all
   
    # provide the variables to link petsc
    export PETSC_DIR=/opt/petsc
    export PETSC_ARCH=arch-linux-c-opt

    # now we have petsc, we can install firedrake
    cd /opt && curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/master/scripts/firedrake-install
    python3 firedrake-install --disable-ssh --package-branch firedrake ksagiyam/plex_io_freeze_distribution --no-package-manager --mpiexec=mpiexec --mpicc=mpicc --mpif90=mpif90 --mpicxx=mpicxx --honour-petsc-dir --pip-install scipy --pip-install assess

    # activate firedrake
    source /opt/firedrake/bin/activate

    # installing
    pip install git+https://github.com/sghelichkhani/pyrol.git@trilinos-cmake
   
    # applying some minor modification, for pyadjoint, and in solving to avoid parallel deadlocks
    cp /mnt/files/__init__.py /opt/firedrake/src/pyadjoint/pyadjoint/__init__.py
    cp /mnt/files/solving_modified.py /opt/firedrake/src/firedrake/firedrake/solving.py 


%runscript
    source /opt/intel/oneapi/setvars.sh "" > /dev/null
    source /opt/firedrake/bin/activate
    export PYOP2_CACHE_DIR=${PBS_JOBFS:-${TMPDIR:-/tmp}}/pyop2
    export FIREDRAKE_TSFC_KERNEL_CACHE_DIR=${PBS_JOBFS:-${TMPDIR:-/tmp}}/tsfc
    export LD_LIBRARY_PATH=/opt/ompi/lib/GNU:$LD_LIBRARY_PATH
    export PATH="/home/sia/Local/cmake/usr/local/bin/":${PATH}
    export PETSC_DIR=/opt/petsc
    export PETSC_ARCH=arch-linux-c-opt
    exec $@

